<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WF-TOOLS ADMIN</title>

  <!-- ‚úÖ Favicon (usa tu mismo PNG si no tienes varios tama√±os) -->
  <link rel="icon" type="image/png" sizes="32x32" href="WF%20TOOLS.png?v=1">
  <link rel="icon" type="image/png" sizes="192x192" href="WF%20TOOLS.png?v=1">
  <link rel="apple-touch-icon" sizes="180x180" href="WF%20TOOLS.png?v=1">
  <meta name="theme-color" content="#0a0b0f" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#0a0b0f; --panel:#0f121a; --muted:#9aa4b2; --text:#e6edf3; --brand:#0ea5e9; --brand-2:#38bdf8;
      --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444; --card:#0c1117; --border:#1b2330; --radius:18px;
      --shadow:0 10px 30px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.03);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:'Space Grotesk',ui-sans-serif,system-ui;
      background:
        radial-gradient(1200px 800px at 70% -10%,rgba(14,165,233,.12),transparent 40%),
        radial-gradient(900px 600px at -10% 110%,rgba(56,189,248,.12),transparent 40%),
        var(--bg);
      color:var(--text);
    }
    a{color:var(--brand)}
    .wrap{min-height:100%; display:grid; place-items:center; padding:28px}

    /* Card base */
    .card{
      width:100%; background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.00));
      border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow);
      backdrop-filter: blur(8px);
    }

    /* Login */
    #loginView{max-width:460px; padding:26px; position:relative}
    .brand{display:flex; flex-direction:column; align-items:center; gap:10px; margin-bottom:18px}
    .brand .logo{
      width:140px; height:140px; display:grid; place-items:center;
      border-radius:18px;
      background: radial-gradient(40% 40% at 50% 50%, rgba(14,165,233,.18), transparent 70%);
      box-shadow:0 12px 38px rgba(14,165,233,.28);
      overflow:hidden;
    }
    .brand .logo img{width:100%; height:100%; object-fit:contain}
    .brand h1{font-family:'Orbitron',ui-sans-serif; font-size:1.4rem; letter-spacing:.04em; margin:6px 0 0}
    .muted{color:var(--muted); font-size:.92rem}

    .field{display:grid; gap:8px; margin:12px 0}
    .field label{font-size:.9rem; color:#cdd6e1}
    .input{border:1px solid var(--border); border-radius:14px; padding:12px 14px; background:#0b0f15; color:#fff; outline:none; width:100%}
    .input:focus{border-color:var(--brand)}
    .input[aria-invalid="true"]{border-color:var(--danger); box-shadow:0 0 0 3px rgba(239,68,68,.15)}

    .btn{cursor:pointer; user-select:none; border:0; border-radius:14px; padding:12px 14px; font-weight:700; letter-spacing:.02em; display:inline-flex; align-items:center; gap:8px}
    .btn[disabled]{opacity:.6; cursor:not-allowed}
    .btn-primary{background:linear-gradient(135deg, var(--brand), var(--brand-2)); color:#00131f; box-shadow:0 10px 25px rgba(14,165,233,.35)}
    .btn-ghost{background:#0b0f15; color:#fff; border:1px solid var(--border)}
    .btn-sm{padding:8px 10px; font-size:.86rem; border-radius:12px}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}

    .hint{margin-top:8px; color:var(--muted); font-size:.86rem}
    .error{color:var(--danger); font-size:.9rem; margin-top:6px}

    /* Admin layout */
    #adminView{display:none; max-width:1200px; margin:0 auto; padding:0}
    .header{display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--border)}
    .title{display:flex; gap:12px; align-items:center}
    .title .logo{
      width:44px; height:44px; border-radius:10px; overflow:hidden;
      background: radial-gradient(40% 40% at 50% 50%, rgba(14,165,233,.18), transparent 70%);
      box-shadow:0 8px 22px rgba(14,165,233,.22);
      display:grid; place-items:center;
    }
    .title .logo img{width:100%; height:100%; object-fit:contain}
    .title h2{font-family:'Orbitron'; margin:0; font-size:1.2rem}

    .toolbar{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .search{display:flex; gap:8px; flex:1; min-width:220px; align-items:center}
    .search input{flex:1}
    .toolbar .btn{display:inline-flex; align-items:center; gap:8px; font-weight:600}
    .toolbar .icon{font-size:1rem}
    .toolbar .btn-search{background:rgba(14,165,233,.16); color:#38bdf8; border:1px solid rgba(14,165,233,.35)}
    .toolbar .btn-reload{background:rgba(59,130,246,.15); color:#93c5fd; border:1px solid rgba(59,130,246,.35)}
    .toolbar .btn-logout{background:rgba(239,68,68,.18); color:#fca5a5; border:1px solid rgba(239,68,68,.45)}

    .panel{padding:16px; position:relative}
    .stats{display:flex; gap:16px; flex-wrap:wrap; margin-bottom:18px}
    .stat-card{flex:1; min-width:200px; display:flex; align-items:center; gap:12px; background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px; box-shadow:var(--shadow)}
    .stat-icon{width:42px; height:42px; border-radius:12px; display:grid; place-items:center; font-size:1.3rem; background:rgba(14,165,233,.14); color:#38bdf8}
    .stat-body{display:grid; gap:4px}
    .stat-title{font-size:.85rem; color:var(--muted)}
    .stat-value{font-size:1.2rem; font-weight:700}
    .stat-sub{font-size:.8rem; color:#8fbfe6}

    /* overlay loading */
    .overlay{
      position:absolute; inset:0; display:none; place-items:center;
      background:rgba(0,0,0,.25); backdrop-filter: blur(2px); border-radius:var(--radius);
    }
    .overlay.show{display:grid}
    .spinner{padding:10px 14px; border:1px solid var(--border); background:var(--panel); border-radius:12px; color:#8fbfe6}

    /* Responsive table wrapper */
    .table-wrap{width:100%; overflow:auto; padding-bottom:6px}
    table{width:100%; border-collapse:separate; border-spacing:0 10px; min-width:800px}
    thead th{font-size:.85rem; text-align:left; color:#cdd6e1; padding:0 10px; white-space:nowrap}
    tbody tr{background:var(--card); border:1px solid var(--border)}
    tbody td{padding:12px 10px; vertical-align:middle}
    tbody td:first-child{border-radius:12px 0 0 12px}
    tbody td:last-child{border-radius:0 12px 12px 0}
    tbody tr{transition:transform .12s ease, box-shadow .12s ease}
    tbody tr:hover{transform:translateY(-2px); box-shadow:0 10px 16px rgba(0,0,0,.25)}
    tbody tr td{border-top:1px solid rgba(255,255,255,.03); border-bottom:1px solid rgba(0,0,0,.25)}

    /* Avatar con logo */
    .avatar{
      width:36px; height:36px; border-radius:10px; border:1px solid var(--border);
      background:#0b0f15; display:grid; place-items:center; overflow:hidden;
    }
    .avatar img{width:100%; height:100%; object-fit:contain}

    .tag{font-size:.75rem; padding:4px 8px; border-radius:999px; border:1px solid var(--border); background:#0a0f15; color:#b7c3d1}
    .actions{display:flex; gap:8px; flex-wrap:wrap; justify-content:center}
    .credit-badge{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-size:.8rem; font-weight:600; letter-spacing:.01em; border:1px solid transparent; flex-wrap:wrap; justify-content:flex-start}
    .credit-badge .dot{width:10px; height:10px; border-radius:50%; display:inline-block}
    .credit-low{background:rgba(239,68,68,.12); color:#fecaca; border-color:rgba(239,68,68,.35)}
    .credit-low .dot{background:var(--danger)}
    .credit-medium{background:rgba(245,158,11,.12); color:#fde68a; border-color:rgba(245,158,11,.3)}
    .credit-medium .dot{background:var(--warn)}
    .credit-high{background:rgba(34,197,94,.15); color:#bbf7d0; border-color:rgba(34,197,94,.35)}
    .credit-high .dot{background:var(--ok)}
    .credit-warning{margin-top:6px; padding:8px 10px; border-radius:12px; font-size:.78rem; background:rgba(239,68,68,.1); border:1px solid rgba(239,68,68,.3); color:#fecaca}
    .password-chip{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:10px; font-family:'Space Grotesk', monospace; font-size:.8rem; letter-spacing:.02em; background:#0b0f15; border:1px solid var(--border); color:#cbd5f5}
    .pager{display:flex; gap:10px; align-items:center; justify-content:flex-end; margin-top:10px}

    /* Empty + skeletons */
    .empty{display:grid; place-items:center; padding:26px; color:var(--muted)}
    .skeleton{background:linear-gradient(90deg, #0d131b, #101720, #0d131b); background-size:200% 100%; animation:shimmer 1.2s infinite; height:48px; border-radius:12px; margin:8px 0; border:1px solid var(--border)}
    @keyframes shimmer{0%{background-position:200% 0} 100%{background-position:-200% 0}}

    /* Modal */
    .modal{position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; padding:20px; z-index:50}
    .modal .content{width:min(560px, 96vw); background:var(--panel); border:1px solid var(--border); border-radius:18px; box-shadow:var(--shadow)}
    .modal .head{display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--border)}
    .modal .body{padding:16px}
    .modal .foot{padding:14px 16px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:8px}

    .pill{font-family:'Orbitron'; font-size:.72rem; letter-spacing:.06em; color:#8fbfe6}
    .sep{height:1px; background:var(--border); margin:6px 0}
    .msg-inline{margin-top:6px; font-size:.85rem}

    /* Mobile cards view */
    @media (max-width: 780px){
      .table-wrap{display:none}
      .cards{display:grid; gap:10px}
      .card-row{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px; display:grid; gap:8px}
      .row-top{display:flex; align-items:center; gap:10px; justify-content:space-between}
      .row-mid{display:grid; grid-template-columns:1fr 1fr; gap:8px}
      .row-actions{display:flex; gap:8px; flex-wrap:wrap}
      .label{font-size:.75rem; color:var(--muted)}
    }
    @media (min-width: 781px){
      .cards{display:none}
    }
  </style>
</head>
<body>
  <div class="wrap">

    <!-- LOGIN VIEW -->
    <section id="loginView" class="card">
      <div class="brand">
        <div class="logo">
          <img id="loginLogo" alt="WF TOOLS logo">
        </div>
        <h1>Acceso ‚Äî Administradores</h1>
        <div class="muted">WF-TOOLS<strong></strong></div>
      </div>
      <div class="field">
        <label>Email</label>
        <input id="email" class="input" type="email" placeholder="admin@tudominio.com" autocomplete="username" />
      </div>
      <div class="field">
        <label>Contrase√±a</label>
        <input id="password" class="input" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
      </div>
      <button id="btnLogin" class="btn btn-primary" style="width:100%">
        <span class="btn-text">Entrar</span>
        <span class="btn-spinner" style="display:none">‚è≥ Iniciando sesi√≥n‚Ä¶</span>
      </button>
      <div class="row" style="margin-top:10px; justify-content:space-between">
        <button id="btnRecover" class="btn btn-ghost">Olvid√© mi contrase√±a</button>
        <span id="loginHint" class="hint">Administrador: Devinson Mena</span>
      </div>
      <div id="loginError" class="error" style="display:none"></div>
    </section>

    <!-- ADMIN VIEW -->
    <section id="adminView" class="card">
      <header class="header">
        <div class="title">
          <div class="logo">
            <img id="headerLogo" alt="WF TOOLS logo">
          </div>
          <div>
            <h2>Panel Administraci√≥n ‚Äî Devinson Mena</h2>
            <div class="pill">Gesti√≥n de usuarios (Supabase)</div>
          </div>
        </div>
        <div class="toolbar">
          <div class="search">
            <input id="q" class="input" placeholder="Buscar por email o nombre" />
            <button id="btnSearch" class="btn btn-search"><span class="icon">üîç</span><span>Buscar</span></button>
          </div>
          <button id="btnReload" class="btn btn-reload"><span class="icon">üîÑ</span><span>Recargar</span></button>
          <button id="btnLogout" class="btn btn-logout"><span class="icon">üö™</span><span>Salir</span></button>
        </div>
      </header>

      <div class="panel">
        <div id="creditSummary" class="stats" style="display:none"></div>
        <!-- overlay -->
        <div id="overlay" class="overlay"><div class="spinner">üîÑ Cargando usuarios‚Ä¶</div></div>

        <!-- skeletons -->
        <div id="skeleton" style="display:none">
          <div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div>
        </div>

        <!-- Desktop table -->
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th style="width:44px"></th>
                <th>Email</th>
                <th>Nombre</th>
                <th>Plan</th>
                <th>Cr√©ditos</th>
                <th>Contrase√±a inicial</th>
                <th>ID</th>
                <th style="width:280px">Acciones</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>

        <!-- Mobile cards -->
        <div id="cards" class="cards"></div>

        <div id="empty" class="empty" style="display:none">No hay usuarios para mostrar</div>

        <div class="pager">
          <button id="prev" class="btn btn-ghost btn-sm">‚óÄ</button>
          <span id="pageInfo" class="muted">P√°gina 1</span>
          <button id="next" class="btn btn-ghost btn-sm">‚ñ∂</button>
        </div>
      </div>
    </section>

    <!-- MODAL EDIT -->
    <div id="modal" class="modal" role="dialog" aria-modal="true">
      <div class="content">
        <div class="head">
          <strong>Editar usuario</strong>
          <button id="closeModal" class="btn btn-ghost btn-sm">‚úï</button>
        </div>
        <div class="body">
          <div class="field"><label>Email</label>
            <input id="m_email" class="input" type="email" required placeholder="usuario@correo.com" />
            <div id="m_email_err" class="msg-inline" style="display:none; color:var(--danger)">El email es obligatorio.</div>
          </div>
          <div class="field"><label>Nombre</label><input id="m_name" class="input" type="text" /></div>
          <div class="row">
            <div class="field" style="flex:1"><label>Plan</label>
              <select id="m_plan" class="input">
                <option>B√°sico</option>
                <option>Avanzado</option>
                <option>√âlite</option>
              </select>
            </div>
            <div class="field" style="flex:1"><label>Cr√©ditos</label>
              <input id="m_credits" class="input" type="number" min="0" />
            </div>
          </div>
          <div class="sep"></div>
          <div class="field"><label>Nueva contrase√±a (opcional)</label>
            <input id="m_password" class="input" type="password" placeholder="Dejar vac√≠o para no cambiar" />
            <div id="m_pwd_err" class="msg-inline" style="display:none; color:var(--danger)">La contrase√±a debe tener al menos 12 caracteres.</div>
          </div>
          <div class="hint">Tambi√©n puedes enviar un link de recuperaci√≥n (no ve la contrase√±a).</div>
        </div>
        <div class="foot">
          <button id="btnRecovery" class="btn btn-ghost">Enviar link de recuperaci√≥n</button>
          <button id="btnSave" class="btn btn-primary">Guardar cambios</button>
        </div>
      </div>
    </div>

  </div>

  <script>
    /************* CONFIG *************/
    const SUPABASE_URL = 'https://htkwcjhcuqyepclpmpsv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0a3djamhjdXF5ZXBjbHBtcHN2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5MTk4MTgsImV4cCI6MjA3MzQ5NTgxOH0.dBeJjYm12YW27LqIxon5ifPR1ygfFXAHVg8ZuCZCEf8';
    const ADMIN_EMAIL = 'stikmena6@gmail.com';
    const FUNCTIONS_BASE = SUPABASE_URL.replace('.supabase.co', '.functions.supabase.co');

    // ‚úÖ Ruta del LOGO (PNG) para el UI
    const LOGO_URL = './WF TOOLS.png';

    const ENDPOINTS = {
      list: 'admin-list',
      update: 'admin-update',
      recovery: 'admin-recovery',
      setPassword: 'admin-setpassword',
    };

    /************* STATE *************/
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    let page = 1; const perPage = 10; let currentRows = []; let currentEdit = null;

    const qs = sel => document.querySelector(sel);
    const $rows = qs('#rows'), $cards = qs('#cards'), $empty = qs('#empty'), $skeleton = qs('#skeleton');
    const loginView = qs('#loginView'), adminView = qs('#adminView'), loginError = qs('#loginError');
    const btnLogin = qs('#btnLogin'), btnLoginText = btnLogin.querySelector('.btn-text'), btnLoginSpinner = btnLogin.querySelector('.btn-spinner');
    const $overlay = qs('#overlay');
    const $creditSummary = qs('#creditSummary');
    const numberFmt = new Intl.NumberFormat('es-CO', { maximumFractionDigits: 0 });
    const averageFmt = new Intl.NumberFormat('es-CO', { maximumFractionDigits: 1 });

    // Inyectar logo en login y header
    qs('#loginLogo').src = LOGO_URL;
    qs('#headerLogo').src = LOGO_URL;

    /************* UI HELPERS *************/
    function show(v){ v.style.display='block'; } function hide(v){ v.style.display='none'; }
    function overlay(on){ $overlay.classList.toggle('show', !!on); }
    function toast(msg, type='ok'){
      const el = document.createElement('div');
      el.textContent = msg;
      Object.assign(el.style, { position:'fixed', bottom:'18px', right:'18px', padding:'10px 14px', border:'1px solid var(--border)', borderRadius:'12px', boxShadow:'var(--shadow)', zIndex:60 });
      const colors = { ok:['#0c1912','#a7f3d0'], warn:['#1a150a','#fde68a'], err:['#1a0e0e','#fecaca'] };
      const [bg, fg] = colors[type] || colors.ok; el.style.background = bg; el.style.color = fg; document.body.append(el); setTimeout(()=>el.remove(), 2800);
    }

    function avatarFor(){ return `<div class="avatar"><img src="${LOGO_URL}" alt="WF TOOLS" /></div>` }

    const PASSWORD_KEYS = ['initial_password','created_password','creation_password','temp_password','generated_password'];
    function getInitialPassword(u){
      for(const key of PASSWORD_KEYS){
        const value = u?.[key];
        if(value) return value;
      }
      return '';
    }

    function creditMeta(rawCredits){
      const value = Number(rawCredits ?? 0);
      if(!Number.isFinite(value) || value <= 0) return { value:0, level:'low', text:'Sin cr√©ditos', recommend:true };
      if(value < 20) return { value, level:'low', text:'Cr√©dito bajo', recommend:true };
      if(value < 60) return { value, level:'medium', text:'Nivel medio', recommend:false };
      return { value, level:'high', text:'Nivel saludable', recommend:false };
    }

    function creditBadge(meta){
      return `<div class="credit-badge credit-${meta.level}"><span class="dot"></span><span>${numberFmt.format(meta.value)} cr√©ditos</span><span>¬∑ ${meta.text}</span></div>`;
    }

    /************* AUTH & API *************/
    async function authHeaderAsync(){
      const { data } = await sb.auth.getSession();
      const t = data.session?.access_token;
      return t ? { Authorization: `Bearer ${t}` } : {};
    }
    async function api(path, { method='GET', headers={}, body=null, query=null } = {}){
      const url = new URL(`${FUNCTIONS_BASE}/${path}`);
      if(query) Object.entries(query).forEach(([k,v])=> v!=null && url.searchParams.set(k,String(v)));
      const auth = await authHeaderAsync();
      const res = await fetch(url, { method, headers:{ 'Content-Type':'application/json', ...auth, ...headers }, body: body? JSON.stringify(body): null });
      if(res.status===401){ toast('Sesi√≥n expirada o no autorizada', 'warn'); await sb.auth.signOut(); hide(adminView); show(loginView); }
      return res;
    }
    async function guardAdmin(){
      const { data } = await sb.auth.getUser();
      const user = data?.user;
      if(!user){ hide(adminView); show(loginView); return false; }
      if(user.email !== ADMIN_EMAIL){ await sb.auth.signOut(); hide(adminView); show(loginView); loginError.style.display='block'; loginError.textContent='No eres administrador.'; return false; }
      return true;
    }

    /************* AUTH FLOW *************/
    qs('#btnLogin').addEventListener('click', async()=>{
      loginError.style.display='none';
      const email = qs('#email').value.trim();
      const password = qs('#password').value;
      if(!email || !password){ loginError.style.display='block'; loginError.textContent='Completa email y contrase√±a'; return; }
      btnLogin.disabled=true; btnLoginText.style.display='none'; btnLoginSpinner.style.display='inline';
      const { error } = await sb.auth.signInWithPassword({ email, password });
      btnLogin.disabled=false; btnLoginText.style.display='inline'; btnLoginSpinner.style.display='none';
      if(error){ loginError.style.display='block'; loginError.textContent = error.message; return; }
      const ok = await guardAdmin(); if(ok){ hide(loginView); show(adminView); loadUsers(); toast('Bienvenido, admin'); }
    });

    qs('#btnRecover').addEventListener('click', async()=>{
      const email = qs('#email').value.trim(); if(!email){ toast('Escribe tu email para enviar el link','warn'); return; }
      await api(ENDPOINTS.recovery, { method:'POST', body:{ email } });
      toast('Si el correo existe, se envi√≥ link de recuperaci√≥n');
    });

    qs('#btnLogout').addEventListener('click', async()=>{ await sb.auth.signOut(); hide(adminView); show(loginView); qs('#password').value=''; });
    sb.auth.onAuthStateChange((_, s)=>{ if(!s){ hide(adminView); show(loginView); } });

    /************* LISTAR USUARIOS *************/
    let searchTimer = null;
    qs('#q').addEventListener('input', ()=>{
      clearTimeout(searchTimer);
      searchTimer = setTimeout(()=>{ page=1; loadUsers(); }, 350);
    });
    qs('#q').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ page=1; loadUsers(); }});
    qs('#btnSearch').addEventListener('click', ()=>{ page=1; loadUsers(); });
    qs('#btnReload').addEventListener('click', ()=> loadUsers());
    qs('#prev').addEventListener('click', ()=>{ if(page>1){ page--; loadUsers(); }});
    qs('#next').addEventListener('click', ()=>{ page++; loadUsers(); });

    async function loadUsers(){
      try{
        overlay(true); $skeleton.style.display='block'; $rows.innerHTML=''; $cards.innerHTML=''; $empty.style.display='none';
        const q = qs('#q').value.trim() || undefined;
        const res = await api(ENDPOINTS.list, { query:{ page, perPage, q } });
        if(!res.ok){ const txt = await res.text(); console.error('list error:',txt); toast('Error cargando usuarios','err'); return; }
        const payload = await res.json(); currentRows = payload.users || [];
        renderRows(); qs('#pageInfo').textContent = `P√°gina ${page}`;
      } finally {
        $skeleton.style.display='none'; overlay(false);
      }
    }

    function renderRows(){
      $rows.innerHTML=''; $cards.innerHTML='';
      $creditSummary.style.display='none';
      if(!currentRows.length){ $empty.style.display='block'; return; }
      $empty.style.display='none';

      let totalCredits = 0;
      let lowCount = 0;

      for(const u of currentRows){
        const meta = creditMeta(u.credits);
        const creditBadgeHtml = creditBadge(meta);
        const displayName = (u.full_name && u.full_name.trim()) || u.email || 'Usuario';
        const creditWarningHtml = meta.recommend ? `<div class="credit-warning">Recargar cr√©ditos a ${displayName}</div>` : '';
        const initialPwd = getInitialPassword(u);
        const passwordHtml = initialPwd ? `<span class="password-chip">${initialPwd}</span>` : '<span class="muted">‚Äî</span>';
        const email = u.email || '';
        const fullName = u.full_name || '';

        totalCredits += meta.value;
        if(meta.recommend) lowCount++;

        // tabla
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${avatarFor()}</td>
          <td>${email}</td>
          <td>${fullName}</td>
          <td><span class="tag">${u.plan || '‚Äî'}</span></td>
          <td>${creditBadgeHtml}${creditWarningHtml}</td>
          <td>${passwordHtml}</td>
          <td style="font-size:.8rem;color:var(--muted)">${u.id}</td>
          <td>
            <div class="actions">
              <button class="btn btn-ghost btn-sm" data-act="edit" data-id="${u.id}">Editar</button>
              <button class="btn btn-ghost btn-sm" data-act="recovery" data-email="${email}">Link recuperaci√≥n</button>
              <button class="btn btn-primary btn-sm" data-act="password" data-id="${u.id}">Cambiar contrase√±a</button>
            </div>
          </td>`;
        $rows.append(tr);

        // cards (m√≥vil)
        const card = document.createElement('div');
        card.className='card-row';
        card.innerHTML = `
          <div class="row-top">
            <div style="display:flex; align-items:center; gap:10px">
              ${avatarFor()}
              <div>
                <div style="font-weight:700">${fullName || '‚Äî'}</div>
                <div class="muted" style="font-size:.85rem">${email}</div>
              </div>
            </div>
            <span class="tag">${u.plan || '‚Äî'}</span>
          </div>
          <div class="row-mid">
            <div><div class="label">Cr√©ditos</div><div>${creditBadgeHtml}</div></div>
            <div><div class="label">ID</div><div style="font-size:.8rem;color:var(--muted)">${u.id}</div></div>
          </div>
          <div>
            <div class="label">Contrase√±a inicial</div>
            <div>${passwordHtml}</div>
          </div>
          ${creditWarningHtml}
          <div class="row-actions">
            <button class="btn btn-ghost btn-sm" data-act="edit" data-id="${u.id}">Editar</button>
            <button class="btn btn-ghost btn-sm" data-act="recovery" data-email="${email}">Recuperaci√≥n</button>
            <button class="btn btn-primary btn-sm" data-act="password" data-id="${u.id}">Cambiar contrase√±a</button>
          </div>`;
        $cards.append(card);
      }

      const totalAccounts = currentRows.length;
      const avgCredits = totalAccounts ? totalCredits / totalAccounts : 0;
      $creditSummary.style.display='flex';
      $creditSummary.innerHTML = `
        <div class="stat-card">
          <div class="stat-icon">üí†</div>
          <div class="stat-body">
            <span class="stat-title">Cr√©ditos activos</span>
            <span class="stat-value">${numberFmt.format(totalCredits)}</span>
            <span class="stat-sub">Suma de todas las cuentas listadas</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üë•</div>
          <div class="stat-body">
            <span class="stat-title">Cuentas visibles</span>
            <span class="stat-value">${totalAccounts}</span>
            <span class="stat-sub">Promedio ${averageFmt.format(avgCredits)} cr√©ditos</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üö®</div>
          <div class="stat-body">
            <span class="stat-title">Alertas de cr√©dito</span>
            <span class="stat-value">${lowCount}</span>
            <span class="stat-sub">${lowCount ? 'Atiende las cuentas marcadas en rojo' : 'Todo en orden'}</span>
          </div>
        </div>`;
    }

    // acciones delegadas
    document.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      const act = btn.dataset.act; if(!act) return;

      if(act==='recovery'){
        const email = btn.dataset.email; if(!email){ toast('Ese usuario no tiene email','warn'); return; }
        btn.disabled = true;
        await api(ENDPOINTS.recovery, { method:'POST', body:{ email } }).catch(()=>{});
        btn.disabled = false; toast('Link de recuperaci√≥n enviado');
      }

      if(act==='password'){
        const id = btn.dataset.id; const pwd = prompt('Nueva contrase√±a (m√≠n 12, segura):'); if(!pwd) return;
        if(pwd.length < 12){ toast('La contrase√±a debe tener al menos 12 caracteres','warn'); return; }
        btn.disabled = true;
        const res = await api(ENDPOINTS.setPassword, { method:'POST', body:{ userId:id, password:pwd } });
        btn.disabled = false;
        if(res.ok) toast('Contrase√±a actualizada'); else toast('No se pudo cambiar','err');
      }

      if(act==='edit'){
        const id = btn.dataset.id; currentEdit = currentRows.find(x=>x.id===id); openModal(currentEdit);
      }
    });

    /************* MODAL *************/
    const modal = qs('#modal');
    const m_email = qs('#m_email');
    const m_email_err = qs('#m_email_err');
    const m_name = qs('#m_name');
    const m_plan = qs('#m_plan');
    const m_credits = qs('#m_credits');
    const m_password = qs('#m_password');
    const m_pwd_err = qs('#m_pwd_err');

    function openModal(u){
      if(!u) return;
      m_email.value = u.email || '';
      m_name.value = u.full_name || '';
      m_plan.value = u.plan || 'B√°sico';
      m_credits.value = u.credits ?? 0;
      m_password.value = '';
      m_email.setAttribute('data-current', u.email || '');
      m_email_err.style.display='none'; m_email.setAttribute('aria-invalid','false');
      m_pwd_err.style.display='none'; m_password.setAttribute('aria-invalid','false');
      modal.style.display='flex';
    }
    qs('#closeModal').addEventListener('click', ()=> modal.style.display='none');

    function validateModal(){
      const email = m_email.value.trim();
      const pwd = m_password.value.trim();
      let ok = true;

      if(!email){
        m_email_err.style.display='block';
        m_email.setAttribute('aria-invalid','true');
        ok = false;
      } else {
        m_email_err.style.display='none';
        m_email.setAttribute('aria-invalid','false');
      }

      if(pwd && pwd.length < 12){
        m_pwd_err.style.display='block';
        m_password.setAttribute('aria-invalid','true');
        ok = false;
      } else {
        m_pwd_err.style.display='none';
        m_password.setAttribute('aria-invalid','false');
      }

      return ok;
    }

    qs('#btnSave').addEventListener('click', async()=>{
      if(!currentEdit) return;
      if(!validateModal()) return;

      const payload = {
        userId: currentEdit.id,
        email: m_email.value.trim(),
        full_name: (m_name.value.trim() || null),
        plan: m_plan.value,
        credits: Number(m_credits.value) || 0,
        newPassword: (m_password.value.trim() || null)
      };

      const btn = qs('#btnSave'); btn.disabled = true; btn.textContent = 'Guardando‚Ä¶';
      const res = await api(ENDPOINTS.update, { method:'POST', body: payload });
      const txt = await res.text();
      btn.disabled = false; btn.textContent = 'Guardar cambios';

      if(!res.ok){
        console.error('update error:', txt);
        toast(`Error al guardar: ${txt}`, 'err');
        return;
      }
      try { const data = JSON.parse(txt); console.log('Perfil guardado:', data.profile); } catch {}

      modal.style.display='none';
      toast('Cambios guardados');
      loadUsers();
    });

    qs('#btnRecovery').addEventListener('click', async()=>{
      if(!currentEdit?.email) return;
      const btn = qs('#btnRecovery'); btn.disabled = true; btn.textContent = 'Enviando‚Ä¶';
      await api(ENDPOINTS.recovery, { method:'POST', body:{ email: currentEdit.email } }).catch(()=>{});
      btn.disabled = false; btn.textContent = 'Enviar link de recuperaci√≥n';
      toast('Link de recuperaci√≥n enviado');
    });

    /************* INIT *************/
    (async()=>{
      const ok = await guardAdmin();
      if(ok){ hide(loginView); show(adminView); loadUsers(); }
    })();
  </script>
</body>
</html>
